# Generated by DeekSeek

import h5py
import numpy as np
from typing import List, Optional, Union

def remove_hdf5_rows(
    filepath: str,
    n_rows: int,
    target_paths: Optional[List[Union[str, tuple]]] = None,
    exclude_paths: Optional[List[str]] = None,
    verbose: bool = True
) -> None:
    """
    åˆ é™¤HDF5æ–‡ä»¶ä¸­æŒ‡å®šè¡¨æ ¼æˆ–è·¯å¾„ä¸‹æ‰€æœ‰è¡¨æ ¼çš„å‰Nè¡Œ
    
    å‚æ•°:
        filepath: HDF5æ–‡ä»¶è·¯å¾„
        n_rows: è¦åˆ é™¤çš„è¡Œæ•°
        target_paths: è¦å¤„ç†çš„ç›®æ ‡è·¯å¾„åˆ—è¡¨ï¼Œå¯ä»¥æ˜¯:
            - å­—ç¬¦ä¸²: å…·ä½“è¡¨æ ¼è·¯å¾„(å¦‚'/data/table1')æˆ–æ–‡ä»¶å¤¹è·¯å¾„(å¦‚'/group/')
            - å…ƒç»„: (è·¯å¾„, æ˜¯å¦é€’å½’) å¦‚('/group/', True)
        exclude_paths: è¦æ’é™¤çš„è·¯å¾„åˆ—è¡¨
        verbose: æ˜¯å¦æ˜¾ç¤ºå¤„ç†è¯¦æƒ…
    
    ç¤ºä¾‹ç”¨æ³•:
        # åˆ é™¤ç‰¹å®šè¡¨æ ¼çš„å‰5è¡Œ
        remove_hdf5_rows("data.h5", 5, ["/experiment/results"])
        
        # é€’å½’åˆ é™¤/sensors/ä¸‹æ‰€æœ‰è¡¨æ ¼çš„å‰3è¡Œ
        remove_hdf5_rows("data.h5", 3, ["/sensors/"])
        
        # åˆ é™¤å¤šä¸ªè·¯å¾„ä¸‹çš„è¡¨æ ¼(æ··åˆå…·ä½“è¡¨æ ¼å’Œæ–‡ä»¶å¤¹)
        remove_hdf5_rows("data.h5", 10, [
            "/experiment/results",  # å…·ä½“è¡¨æ ¼
            ("/sensors/", True),    # é€’å½’å¤„ç†
            ("/temp_data", False)   # ä¸é€’å½’
        ])
    """
    def printv(*args, **kwargs):
        if verbose:
            print(*args, **kwargs)

    def should_process(path: str) -> bool:
        """åˆ¤æ–­è·¯å¾„æ˜¯å¦åº”è¯¥è¢«å¤„ç†"""
        # æ£€æŸ¥æ’é™¤è·¯å¾„
        if exclude_paths and any(path.startswith(p.rstrip('/')) for p in exclude_paths):
            return False
        
        # å¦‚æœæ²¡æœ‰æŒ‡å®štarget_pathsï¼Œåˆ™å¤„ç†æ‰€æœ‰æ•°æ®é›†
        if target_paths is None:
            return True
            
        # æ£€æŸ¥æ˜¯å¦åŒ¹é…ä»»ä½•ç›®æ ‡è·¯å¾„è§„åˆ™
        for rule in target_paths:
            if isinstance(rule, str):
                # å­—ç¬¦ä¸²è§„åˆ™: å®Œå…¨åŒ¹é…æˆ–å‰ç¼€åŒ¹é…
                if path == rule or path.startswith(rule.rstrip('/') + '/'):
                    return True
            elif isinstance(rule, tuple) and len(rule) == 2:
                path_part, recursive = rule
                path_part = path_part.rstrip('/')
                if recursive and path.startswith(path_part + '/'):
                    return True
                elif not recursive and (path == path_part or 
                                      path.startswith(path_part + '/') and 
                                      '/' not in path[len(path_part)+1:]):
                    return True
        return False

    with h5py.File(filepath, 'a') as f:
        # æ”¶é›†æ‰€æœ‰éœ€è¦å¤„ç†çš„è¡¨æ ¼è·¯å¾„
        targets = []
        
        def collect_tables(name, obj):
            if isinstance(obj, h5py.Dataset) and should_process(name):
                targets.append(name)
        
        f.visititems(collect_tables)
        
        if not targets:
            printv("æ²¡æœ‰æ‰¾åˆ°å¯å¤„ç†çš„è¡¨æ ¼")
            return

        # å¤„ç†æ¯ä¸ªè¡¨æ ¼
        for table_path in targets:
            try:
                dataset = f[table_path]
                orig_shape = dataset.shape
                
                if len(dataset) <= n_rows:
                    printv(f"è·³è¿‡ {table_path} (è¡Œæ•°ä¸è¶³: {len(dataset)} <= {n_rows})")
                    continue
                
                # è¯»å–æ•°æ®(è·³è¿‡å‰n_rowsè¡Œ)
                new_data = dataset[n_rows:]
                
                # ä¿å­˜å±æ€§
                attrs = dict(dataset.attrs)
                
                # åˆ é™¤åŸæ•°æ®é›†
                del f[table_path]
                
                # åˆ›å»ºæ–°æ•°æ®é›†
                new_dataset = f.create_dataset(table_path, data=new_data)
                
                # æ¢å¤å±æ€§
                for name, value in attrs.items():
                    new_dataset.attrs[name] = value
                
                printv(f"å¤„ç†æˆåŠŸ {table_path}: {orig_shape} â†’ {new_data.shape}")
                
            except Exception as e:
                printv(f"å¤„ç† {table_path} å¤±è´¥: {str(e)}")
                continue

    printv(f"å¤„ç†å®Œæˆ! å…±å¤„ç†äº† {len(targets)} ä¸ªè¡¨æ ¼")
    
def print_hdf5_structure(filepath):
    with h5py.File(filepath, 'r') as f:
        print(f"æ–‡ä»¶ç»“æ„: {filepath}")
        def print_item(name, obj):
            indent = '  ' * name.count('/')
            if isinstance(obj, h5py.Dataset):
                print(f"{indent}ğŸ“Š æ•°æ®é›†: {name} (å½¢çŠ¶: {obj.shape}, ç±»å‹: {obj.dtype})")
            elif isinstance(obj, h5py.Group):
                print(f"{indent}ğŸ“ ç»„: {name}")
        f.visititems(print_item)

# æ›¿æ¢ä¸ºæ‚¨çš„å®é™…æ–‡ä»¶è·¯å¾„


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    # ç¤ºä¾‹1: é€’å½’åˆ é™¤/sensors/ä¸‹æ‰€æœ‰è¡¨æ ¼çš„å‰3è¡Œ
    # remove_hdf5_rows("data.h5", 3, ["/sensors/"])
    
    demo_invalid_num = [23,37,13,16,59,    41,19,38,15,14]
    
    for index, value in enumerate(demo_invalid_num):
        print(f"data_{index} delete {value} row")
        # ç¤ºä¾‹2: æ··åˆæ¨¡å¼å¤„ç†
        target_paths = [        
            f'data/demo_{index}/actions',
            f'data/demo_{index}/joint_actions',
            (f'data/demo_{index}/obs/', True),        # è¯¥æ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰è¡¨æ ¼(é€’å½’)
            (f'data/demo_{index}/states/', True),
        ]

        remove_hdf5_rows("/mnt/data/src/edit_hdf5/dataset_record_pick_place_post_process.hdf5", 
                         value, 
                         target_paths=target_paths,)
    
    # ç¤ºä¾‹3: å¤„ç†æ–‡ä»¶ä¸­æ‰€æœ‰è¡¨æ ¼(é™¤/system/ä¸‹çš„)
    # remove_hdf5_rows("data.h5", 10, exclude_paths=["/system/"])
    
    # print_hdf5_structure("/mnt/data/src/edit_hdf5/dataset_record_pick_place_post_process.hdf5")
